generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// -----------------------------
// ENUMS
// -----------------------------
enum Role {
  USER
  DONOR
  ADMIN
  STUDENT_PRESIDENT
}

enum ProjectStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  PAUSED
  FROZEN
}

enum BankAccountStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

//Account related statuses
enum AccountStatus {
  ACTIVE
  BLOCKED
  SUSPENDED
  UNDER_REVIEW
}

enum MilstoneStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
}

// -----------------------------
// USER MODEL
// -----------------------------
model User {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  email      String  @unique
  password   String?
  name       String?
  role       Role    @default(USER)
  googleId   String?
  linkedinId String?

  //account status
  accountStatus AccountStatus @default(ACTIVE)

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password reset
  resetPasswordToken  String?
  resetPasswordExpiry DateTime?
  clubVerifications   ClubVerification[] @relation("UserClubVerifications")

  // Campaign / club related flags
  canCreateCampaign    Boolean    @default(false) // toggled when president is approved
  isClubMember         Boolean    @default(false) // true when matched with ClubMember
  clubIds              String[]   @db.ObjectId
  clubs                Club[]     @relation("UserClubRelation", fields: [clubIds], references: [id])
  hasPaid              Boolean    @default(false) // payment status for campaign permission
  isClubPresident      Boolean    @default(false)
  isExternallyVerified Boolean    @default(false) // KYC / 3rd-party verification status
  clubVerified         Boolean    @default(false)
  studentVerified      Boolean    @default(false)
  donations            Donation[]
  comments CampaignComment[] @relation("UserComments")

  subscriptionStatus String    @default("NONE") // NEW
  subscriptionId     String? // NEW
  subscriptionExpiry DateTime? // NEW

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userProjects        UserProject[]
  bankAccounts        BankAccount[]
  applications        Application[] // Applications to donor projects
  clubsPresided       Club[]               @relation("ClubPresident")
  studentVerification StudentVerification?

  // reverse relation (ClubMember.user)
  clubMembers ClubMember[] // optional helper

  //admin feature
  adminNotes AdminNote[] @relation("AdminNoteAuthor")
  auditLogs  AuditLog[]  @relation("AuditLogPerformer")

  notesReceived AdminNote[] @relation("UserNotes")
  @@index([googleId])
  @@index([linkedinId])
  @@index([accountStatus])
}

// -----------------------------
// DONOR MODEL
// -----------------------------
model Donor {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  name             String
  email            String  @unique
  password         String?
  organizationName String?
  verified         Boolean @default(false)
  googleId         String?
  linkedinId       String?

  //account status
  accountStatus AccountStatus @default(ACTIVE)

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password reset
  resetPasswordToken  String?
  resetPasswordExpiry DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  donations     Donation[]
  donorProjects DonorProject[]
  wishlist      Wishlist[]
  adminNotes    AdminNote[]
  comments CampaignComment[] @relation("DonorComments")




  @@index([googleId])
  @@index([linkedinId])
}

// -----------------------------
// USER PROJECT MODEL
// (projects created by USERS to receive donations)
// -----------------------------
model UserProject {
  id                  String        @id @default(auto()) @map("_id") @db.ObjectId
  title               String
  slug                String? @unique
  description         String
  companyName         String?
  collegeName         Json? //[name, logo]
  skillsRequired      String[]
  timeline            String?
  goalAmount          Float
  amountRaised        Float         @default(0)
  imageUrl            String?
  campaignMedia       String[]      @default([])
  presentationDeckUrl String?
  status              ProjectStatus @default(PENDING)
  rejectionReason     String? // Admin's reason for rejection
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  campaignType        String        @default("INDIVIDUAL")
  // "INDIVIDUAL" | "TEAM"

  teamMembers Json?
  // [{ name, role, image }]

  faqs Json?
  // [{ question, answer }]

  youtubeUrl String?
  // Relation to user (creator)
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments CampaignComment[] @relation("ProjectComments")



  clubId String? @db.ObjectId
  club   Club?   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  // Bank account for payout
  bankAccountId String?      @db.ObjectId
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])

  // Donations from donors
  donations    Donation[]
  withdrawals  Withdrawal[]
  wishlistedBy Wishlist[]
  milestones   Milestone[]

  //admin notes
  adminNotes AdminNote[]

  @@index([userId])
  @@index([status])
  @@index([clubId, status])

}

//-----------------------------------
//MILESTONE
//-----------------------------------
model Milestone {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  timeline    String
  budget      Float
  description String?

  //Verification fields
  status        MilstoneStatus @default(PENDING)
  proofUrl      String?
  adminFeedback String?
  approvedAt    DateTime?

  // Relation
  projectId String      @db.ObjectId
  project   UserProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

// -----------------------------
// DONOR PROJECT MODEL
// (projects created by DONORS - funding initiatives or sponsorships)
// -----------------------------
model DonorProject {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String
  organization    String?
  skillsRequired  String[]
  timeline        String?
  totalBudget     Float
  allocatedFunds  Float         @default(0)
  imageUrl        String?
  status          ProjectStatus @default(PENDING)
  rejectionReason String? // Admin's reason for rejection
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relation to donor (creator)
  donorId String @db.ObjectId
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)

  // Applications from students
  applications Application[]

  //adminNotes
  adminNotes AdminNote[]

  @@index([donorId])
  @@index([status])
}

// -----------------------------
// APPLICATION MODEL
// (students applying to donor projects)
// -----------------------------
// schema.prisma - Application model
model Application {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  coverLetter     String
  skills          String[]
  status          ApplicationStatus @default(PENDING)
  rejectionReason String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // âœ… Make relations SAFE for Studio
  userId String @db.ObjectId
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)

  donorProjectId String        @db.ObjectId
  donorProject   DonorProject? @relation(fields: [donorProjectId], references: [id], onDelete: Cascade)

  @@unique([userId, donorProjectId])
  @@index([userId])
  @@index([donorProjectId])
  @@index([status])
}

// -----------------------------
// DONATION MODEL
// -----------------------------
model Donation {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  amount    Float
  message   String?
  anonymous Boolean @default(false)

  // ðŸ”‘ Logged-in identity (student / admin / donor / OAuth)
  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  // ðŸ‘¤ Custom donor profile (legacy / features)
  donorId String? @db.ObjectId
  donor   Donor?  @relation(fields: [donorId], references: [id])

  // ðŸ§¾ Guest snapshot
  guestName  String?
  guestEmail String?
  guestPAN   String?

  // ðŸŽ¯ Project
  userProjectId String      @db.ObjectId
  userProject   UserProject @relation(fields: [userProjectId], references: [id], onDelete: Cascade)

  // ðŸ’³ Payment
  paymentStatus     String  @default("created")
  razorpayOrderId   String? @unique
  razorpayPaymentId String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([donorId])
  @@index([userProjectId])
}

// -----------------------------
// BANK ACCOUNT MODEL
// -----------------------------
model BankAccount {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  accountHolderName String
  accountNumber     String
  bankName          String
  status            BankAccountStatus @default(PENDING_VERIFICATION)
  isDefault         Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  userProjects UserProject[]
}

// -----------------------------
// WITHDRAWAL MODEL
// -----------------------------
model Withdrawal {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  amount    Float
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userProjectId String      @db.ObjectId
  userProject   UserProject @relation(fields: [userProjectId], references: [id])
}

// -----------------------------
// CLUB MODEL (new)
// -----------------------------
model Club {
  id              String  @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  slug            String? @unique
  college         String
  description     String?
  presidentEmail  String
  presidentUserId String? @db.ObjectId
  presidentUser   User?   @relation("ClubPresident", fields: [presidentUserId], references: [id])
  users           User[]   @relation("UserClubRelation", fields: [userIds], references: [id])
  userIds         String[] @db.ObjectId
  members         ClubMember[]
  campaigns       UserProject[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  adminNotes      AdminNote[]

  @@index([presidentEmail])
  @@index([college])
}

// -----------------------------
// CLUB MEMBER MODEL (new)
// -----------------------------
model ClubMember {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  clubId String @db.ObjectId
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  email String
  name  String?
  phone String?

  isUserRegistered Boolean @default(false)
  userId           String? @db.ObjectId
  user             User?   @relation(fields: [userId], references: [id])
  isVerified       Boolean @default(false)

  addedBy   String? // optional: user id of president who added
  createdAt DateTime @default(now())

  @@unique([clubId, email])
  @@index([clubId])
  @@index([email])
}

// -----------------------------
// CLUB REFERRAL REQUEST (for initial president / FIC verification)
// -----------------------------
model ClubReferralRequest {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Club details
  clubName    String
  collegeName String

  // Student referrer (who referred the club)
  referrerId    String?
  referrerEmail String

  // President information
  presidentName  String
  presidentEmail String
  presidentPhone String

  // Faculty information
  ficName  String?
  ficEmail String?
  ficPhone String?

  // Social links
  instagram String?
  linkedIn  String?
  portfolio String?

  // Supporting documents (images/PDF)
  evidenceUrls String[] @default([])

  // Verification states
  status     String  @default("PENDING") // PENDING, PRESIDENT_VERIFIED, REJECTED, VERIFIED
  adminNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([referrerEmail])
  @@index([presidentEmail])
}

model ClubVerification {
  id            String  @id @default(auto()) @map("_id") @db.ObjectId
  collegeName   String
  studentEmail  String
  studentPhone  String
  presidentName String
  ficName       String
  ficEmail      String
  ficPhone      String
  docUrl        String?
  status        String  @default("PENDING")

  // NEW â€” required by feature
  clubName        String?
  clubDescription String?
  clubInstagram   String?
  clubLinkedIn    String?
  clubYouTube     String?
  alumni          Json?

  userId String? @db.ObjectId
  user   User?   @relation("UserClubVerifications", fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------
// SUBSCRIBER MODEL (Newsletter)
// -----------------------------
model Subscriber {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  isActive  Boolean  @default(true)
  source    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------
// WISHLIST MODEL (new)
// -----------------------------
model Wishlist {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  donorId String @db.ObjectId
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)

  userProjectId String      @db.ObjectId
  userProject   UserProject @relation(fields: [userProjectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([donorId, userProjectId])
  @@index([donorId])
}

// -----------------------------
// Additional notes: keep your existing models and relations unchanged.
// -----------------------------
//----------------------------------
// Campaign Comments (User OR Donor)
//----------------------------------
model CampaignComment {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  campaignId String   @db.ObjectId
  campaign   UserProject @relation("ProjectComments", fields: [campaignId], references: [id], onDelete: Cascade)

  // Polymorphic identity (exactly one must be set)
  userId     String?  @db.ObjectId
  user       User?    @relation("UserComments", fields: [userId], references: [id], onDelete: Cascade)

  donorId    String?  @db.ObjectId
  donor      Donor?   @relation("DonorComments", fields: [donorId], references: [id], onDelete: Cascade)

  parentId   String?  @db.ObjectId

  content    String
  isDeleted  Boolean  @default(false)
  isFlagged  Boolean  @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([campaignId])
  @@index([userId])
  @@index([donorId])
  @@index([parentId])
}




// -----------------------------
// STUDENT VERIFICATION MODEL
// -----------------------------
model StudentVerification {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  fullName      String
  studentEmail  String
  officialEmail String
  mobileNumber  String
  docType       String
  documentUrl   String // Cloudinary URL

  // Payment Details
  razorpayPaymentId String?
  razorpayOrderId   String?
  razorpaySignature String?

  status String @default("PENDING") // PENDING, VERIFIED, REJECTED

  userId String @unique @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//-------------------------
// AUDIT LOGS & ADMIN NOTES
//-------------------------

//records every action taken by an admin
model AuditLog {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  action   String
  entity   String
  entityId String

  performedBy String @db.ObjectId
  admin       User   @relation("AuditLogPerformer", fields: [performedBy], references: [id])

  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([entityId])
  @@index([action])
  @@index([performedBy])
}

//internal noting for admin (invisible to users)
model AdminNote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  createdAt DateTime @default(now())

  // Author
  authorId String @db.ObjectId
  author   User   @relation("AdminNoteAuthor", fields: [authorId], references: [id])

  // Relations (Target Entities)
  userProject   UserProject? @relation(fields: [userProjectId], references: [id])
  userProjectId String?      @db.ObjectId

  donorProject   DonorProject? @relation(fields: [donorProjectId], references: [id])
  donorProjectId String?       @db.ObjectId

  targetUser   User?   @relation("UserNotes", fields: [targetUserId], references: [id])
  targetUserId String? @db.ObjectId

  targetClub   Club?   @relation(fields: [targetClubId], references: [id])
  targetClubId String? @db.ObjectId

  targetDonor   Donor?  @relation(fields: [targetDonorId], references: [id])
  targetDonorId String? @db.ObjectId
}
