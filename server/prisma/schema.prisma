generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// -----------------------------
// ENUMS
// -----------------------------
enum Role {
  USER
  DONOR
  ADMIN
  STUDENT_PRESIDENT
}

enum ProjectStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum BankAccountStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// -----------------------------
// USER MODEL
// -----------------------------
model User {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  email      String  @unique
  password   String?
  name       String?
  role       Role    @default(USER)
  googleId   String?
  linkedinId String?

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password reset
  resetPasswordToken  String?
  resetPasswordExpiry DateTime?
  clubVerifications   ClubVerification[] @relation("UserClubVerifications")

  // Campaign / club related flags
  canCreateCampaign    Boolean @default(false) // toggled when president is approved
  isClubMember         Boolean @default(false) // true when matched with ClubMember
  clubId               String? @db.ObjectId // reference to Club.id (optional)
  club                 Club?   @relation("UserClubRelation", fields: [clubId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  hasPaid              Boolean @default(false) // payment status for campaign permission
  isClubPresident      Boolean @default(false)
  isExternallyVerified Boolean @default(false) // KYC / 3rd-party verification status
  clubVerified         Boolean @default(false)

  subscriptionStatus String    @default("NONE") // NEW
  subscriptionId     String? // NEW
  subscriptionExpiry DateTime? // NEW

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userProjects  UserProject[]
  bankAccounts  BankAccount[]
  applications  Application[] // Applications to donor projects
  clubsPresided Club[]        @relation("ClubPresident")

  // reverse relation (ClubMember.user)
  clubMembers ClubMember[] // optional helper

  @@index([googleId])
  @@index([linkedinId])
}

// -----------------------------
// DONOR MODEL
// -----------------------------
model Donor {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  name             String
  email            String  @unique
  password         String?
  organizationName String?
  verified         Boolean @default(false)
  googleId         String?
  linkedinId       String?

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password reset
  resetPasswordToken  String?
  resetPasswordExpiry DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  donations     Donation[]
  donorProjects DonorProject[]
  wishlist      Wishlist[]

  @@index([googleId])
  @@index([linkedinId])
}

// -----------------------------
// USER PROJECT MODEL
// (projects created by USERS to receive donations)
// -----------------------------
model UserProject {
  id                  String        @id @default(auto()) @map("_id") @db.ObjectId
  title               String
  description         String
  companyName         String?
  skillsRequired      String[]
  timeline            String?
  goalAmount          Float
  amountRaised        Float         @default(0)
  imageUrl            String?
  campaignMedia       String[]      @default([])
  presentationDeckUrl String?
  status              ProjectStatus @default(PENDING)
  rejectionReason     String? // Admin's reason for rejection
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relation to user (creator)
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Bank account for payout
  bankAccountId String?      @db.ObjectId
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])

  // Donations from donors
  donations    Donation[]
  withdrawals  Withdrawal[]
  wishlistedBy Wishlist[]

  milestones Milestone[]

  @@index([userId])
  @@index([status])
}

//-----------------------------------
//MILESTONE
//-----------------------------------
model Milestone {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  timeline    String
  budget      Float
  description String?

  // Relation
  projectId String      @db.ObjectId
  project   UserProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

// -----------------------------
// DONOR PROJECT MODEL
// (projects created by DONORS - funding initiatives or sponsorships)
// -----------------------------
model DonorProject {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String
  organization    String?
  skillsRequired  String[]
  timeline        String?
  totalBudget     Float
  allocatedFunds  Float         @default(0)
  imageUrl        String?
  status          ProjectStatus @default(PENDING)
  rejectionReason String? // Admin's reason for rejection
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relation to donor (creator)
  donorId String @db.ObjectId
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)

  // Applications from students
  applications Application[]

  @@index([donorId])
  @@index([status])
}

// -----------------------------
// APPLICATION MODEL
// (students applying to donor projects)
// -----------------------------
model Application {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  coverLetter     String // Why they want to join
  skills          String[] // Skills they can contribute
  status          ApplicationStatus @default(PENDING)
  rejectionReason String? // Donor's reason for rejection
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relation to student (User)
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relation to donor project
  donorProjectId String       @db.ObjectId
  donorProject   DonorProject @relation(fields: [donorProjectId], references: [id], onDelete: Cascade)

  @@unique([userId, donorProjectId]) // One application per user per project
  @@index([userId])
  @@index([donorProjectId])
  @@index([status])
}

// -----------------------------
// DONATION MODEL
// -----------------------------
model Donation {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  amount    Float
  message   String?
  anonymous Boolean @default(false)

  donorId String? @db.ObjectId // for logged-in donors
  donor   Donor?  @relation(fields: [donorId], references: [id])

  guestName  String? // NEW
  guestEmail String? // NEW
  guestPAN   String?

  userProjectId String      @db.ObjectId
  userProject   UserProject @relation(fields: [userProjectId], references: [id], onDelete: Cascade)

  paymentStatus String @default("pending")

  razorpayOrderId   String?
  razorpayPaymentId String?

  createdAt DateTime @default(now())
}

// -----------------------------
// BANK ACCOUNT MODEL
// -----------------------------
model BankAccount {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  accountHolderName String
  accountNumber     String
  bankName          String
  status            BankAccountStatus @default(PENDING_VERIFICATION)
  isDefault         Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  userProjects UserProject[]
}

// -----------------------------
// WITHDRAWAL MODEL
// -----------------------------
model Withdrawal {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  amount    Float
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userProjectId String      @db.ObjectId
  userProject   UserProject @relation(fields: [userProjectId], references: [id])
}

// -----------------------------
// CLUB MODEL (new)
// -----------------------------
model Club {
  id              String  @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  college         String
  description     String?
  presidentEmail  String
  presidentUserId String? @db.ObjectId
  presidentUser   User?   @relation("ClubPresident", fields: [presidentUserId], references: [id])
  users           User[]  @relation("UserClubRelation")

  members   ClubMember[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([presidentEmail])
}

// -----------------------------
// CLUB MEMBER MODEL (new)
// -----------------------------
model ClubMember {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  clubId String @db.ObjectId
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  email String
  name  String?
  phone String?

  isUserRegistered Boolean @default(false)
  userId           String? @db.ObjectId
  user             User?   @relation(fields: [userId], references: [id])
  isVerified       Boolean @default(false)

  addedBy   String? // optional: user id of president who added
  createdAt DateTime @default(now())

  @@unique([clubId, email])
  @@index([clubId])
  @@index([email])
}

// -----------------------------
// CLUB REFERRAL REQUEST (for initial president / FIC verification)
// -----------------------------
model ClubReferralRequest {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Club details
  clubName    String
  collegeName String

  // Student referrer (who referred the club)
  referrerId    String?
  referrerEmail String

  // President information
  presidentName  String
  presidentEmail String
  presidentPhone String

  // Faculty information
  ficName  String?
  ficEmail String?
  ficPhone String?

  // Social links
  instagram String?
  linkedIn  String?
  portfolio String?

  // Supporting documents (images/PDF)
  evidenceUrls String[] @default([])

  // Verification states
  status     String  @default("PENDING") // PENDING, PRESIDENT_VERIFIED, REJECTED, VERIFIED
  adminNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([referrerEmail])
  @@index([presidentEmail])
}

model ClubVerification {
  id            String  @id @default(auto()) @map("_id") @db.ObjectId
  collegeName   String
  studentEmail  String
  studentPhone  String
  presidentName String
  ficName       String
  ficEmail      String
  ficPhone      String
  docUrl        String?
  status        String  @default("PENDING")

  userId String? @db.ObjectId
  user   User?   @relation("UserClubVerifications", fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------
// SUBSCRIBER MODEL (Newsletter)
// -----------------------------
model Subscriber {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  isActive  Boolean  @default(true)
  source    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------
// WISHLIST MODEL (new)
// -----------------------------
model Wishlist {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  donorId String @db.ObjectId
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)

  userProjectId String      @db.ObjectId
  userProject   UserProject @relation(fields: [userProjectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([donorId, userProjectId])
  @@index([donorId])
}

// -----------------------------
// Additional notes: keep your existing models and relations unchanged.
// -----------------------------
